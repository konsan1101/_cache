The core logic is here only